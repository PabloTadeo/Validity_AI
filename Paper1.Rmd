---
title: "AI_FOD_Adjusted"
author: "Pablo Tadeo"
date: "2025-02-15"
output: html_document
---

```{r setup}
# Core imports
library(tidyverse)    # Includes dplyr, ggplot2, readr, and more
library(readxl)       # For Excel files
library(janitor)      # For data cleaning
library(ggprism)      # For enhanced ggplot2 themes
library(ggpubr)       # For publication-ready plots
library(rstatix)      # shapiro wilk

# reliability and validity
library(irr)          # reliability
library(blandr)       # Bland-Altman plots
library(bmbstats)     # ordinary least products

# Tables
library(gtsummary)    # For creating summary tables
library(knitr)
```

#Data cleaning and wrangling

```{r}
# Load the CSV file with the full path
df <- read_csv("/Users/pablotadeo/Desktop/Data_PhD.AllJump_AllDevices.csv")

# Clean column names to ensure consistency
df <- clean_names(df)

# Convert `id` and `intento` to character
df <- df %>%
  mutate(id = as.character(id), intento = as.character(intento))

# Rearrange columns: ID first, then character variables, followed by numeric variables
df <- df %>%
  select(id, where(is.character), where(is.numeric), -sexo)

# Display the first few rows of the cleaned dataframe
head(df)
```

Translate column names from Spanish to English

```{r}
# Rename columns to English
names(df) <- c(
  "id",                  # ID
  "group",               # Group
  "session",             # Session
  "jump_type",           # Jump Type
  "attempt",             # Attempt
  "age_years",           # Age (years)
  "weight_fd_test",      # Weight (ForceDecks Test)
  "weight_fd_retest",    # Weight (ForceDecks Retest)
  "weight_tanita",       # Weight (Tanita)
  "height_m",            # Height (meters)
  "bmi",                 # BMI
  "body_fat_percent",    # Body Fat (%)
  "body_fat_kg",         # Body Fat (kg)
  "muscle_mass_percent", # Muscle Mass (%)
  "muscle_mass_kg",      # Muscle Mass (kg)
  "water_percent",       # Water (%)
  "water_kg",            # Water (kg)
  "visceral_fat_percent",# Visceral Fat (%)
  "leg_length_cm",       # Leg Length (cm)
  "height_90_cm",        # Height 90° (cm)
  "lever_cm",            # Lever (cm)
  "force_decks_height",  # ForceDecks Height
  "my_jump_a_height",    # My Jump A Height
  "my_jump_b_height",    # My Jump B Height
  "my_jump_ai_height",   # My Jump AI Height
  "ir_mat_height"        # Infrared Mat Height
)

# Translate groups into English
df$group <- factor(
  df$group,
  levels = c("No Deportista", "Basquetbol", "Voleibol", "Futbol"),
  labels = c("Recreational Athlete", "Basketball", "Volleyball", "Soccer")
)

# Check the dataframe structure after renaming
glimpse(df)
```

```{r}
# Check column names after clean_names()
names(df)
```

# My Jump AI Adjusted

```{r}
# Check column names
names(df)
```

```{r}
df <- clean_names(df)
```

```{r}
# Apply the filter and adjustment, creating ai_app_height
df <- df %>%
  filter(!is.na(my_jump_ai_height)) %>%          # Remove rows with missing values
  filter(my_jump_ai_height >= 20, my_jump_ai_height <= 75) %>%  # Filter outliers
  mutate(ai_app_height = my_jump_ai_height - 2.5)  # Apply adjustment and create ai_app_height
```

```{r}
# Check the updated structure
glimpse(df)
```

```{r}
summary(df$ai_app_height)
```

```{r}
df <- df %>% filter(ai_app_height>= 20, ai_app_height <= 75)
```

```{r}
summary(df$ai_app_height)
```

```{r}
# Check column names again
names(df)
```

```{r}
# Check the first rows and summary statistics
head(df)
summary(df$ai_app_height)
```

# Table 1. Descriptive Statistics of Anthropometric and Body Composition Characteristics Across Athlete Groups. 

```{r}
# Load gt for high-quality table creation
library(gt)

# Prepare summary statistics with the selected variables
table1_clean <- df %>%
  group_by(group) %>%
  summarise(
    `Age (years)` = sprintf("%.1f ± %.1f", mean(age_years, na.rm = TRUE), sd(age_years, na.rm = TRUE)),
    `Weight (kg)` = sprintf("%.1f ± %.1f", mean(weight_fd_test, na.rm = TRUE), sd(weight_fd_test, na.rm = TRUE)),
    `Height (m)` = sprintf("%.2f ± %.2f", mean(height_m, na.rm = TRUE), sd(height_m, na.rm = TRUE)),
    `BMI (kg/m²)` = sprintf("%.1f ± %.1f", mean(bmi, na.rm = TRUE), sd(bmi, na.rm = TRUE)),
    `Body Fat (%)` = sprintf("%.1f ± %.1f", mean(body_fat_percent, na.rm = TRUE), sd(body_fat_percent, na.rm = TRUE)),
    `Muscle Mass (%)` = sprintf("%.1f ± %.1f", mean(muscle_mass_percent, na.rm = TRUE), sd(muscle_mass_percent, na.rm = TRUE))
  ) %>%
  pivot_longer(-group, names_to = "Variable", values_to = "Mean ± SD") %>%
  pivot_wider(names_from = group, values_from = `Mean ± SD`)

# Create the clean and minimal table
table1_clean %>%
  gt() %>%
  tab_header(
    title = "Table 1. Descriptive Statistics of Anthropometric and Body Composition Characteristics",
    subtitle = "Grouped by Athlete Type"
  ) %>%
  cols_label(
    Variable = "Variable",
    `Recreational Athlete` = "Recreational Athlete",
    Basketball = "Basketball Players",
    Soccer = "Soccer Players",
    Volleyball = "Volleyball Players",
  ) %>%
  tab_options(
    table.font.size = 12,
    column_labels.font.weight = "bold",
    data_row.padding = px(6)
  )
```

```{r}
# Load necessary libraries
library(gt)
library(dplyr)
library(tidyr)

# Crear un dataframe con los valores proporcionados y sus promedios en la columna Overall
table1_clean <- tibble::tibble(
  Variable = c("Age (years)", "Weight (kg)", "Height (m)", "BMI (kg/m²)", 
               "Body Fat (%)", "Muscle Mass (%)", "Force Platform (cm) - Test", "Force Platform (cm) - Retest"),
  
  `Recreational Athletes` = c("21.3 ± 2.0", "75.8 ± 16.3", "1.71 ± 0.05", "25.6 ± 6.1", 
                              "20.3 ± 6.5", "75.7 ± 6.1", "32.5 ± 7.8", "33.5 ± 7.9"),
  
  `Basketball Players` = c("20.0 ± 1.5", "79.8 ± 10.3", "1.79 ± 0.08", "25.0 ± 3.6", 
                           "19.0 ± 8.4", "77.1 ± 8.0", "37.0 ± 8.6", "37.7 ± 8.3"),
  
  `Soccer Players` = c("20.1 ± 1.6", "65.4 ± 5.5", "1.71 ± 0.06", "22.3 ± 2.5", 
                       "16.2 ± 4.9", "77.5 ± 12.4", "33.8 ± 6.0", "34.2 ± 5.4"),
  
  `Volleyball Players` = c("21.2 ± 1.7", "82.6 ± 14.6", "1.87 ± 0.10", "23.5 ± 3.5", 
                           "10.6 ± 1.7", "47.5 ± 8.1", "44.2 ± 7.7", "46.2 ± 8.0"),
  
  # Cálculo del promedio global con desviación estándar, ajustado manualmente
  `Overall` = c(
    "20.7 ± 1.7", # Age
    "75.9 ± 11.7", # Weight
    "1.77 ± 0.07", # Height
    "24.1 ± 4.0", # BMI
    "16.5 ± 5.4", # Body Fat
    "69.5 ± 8.7", # Muscle Mass
    "37.4 ± 8.9", # Force Platform - Test
    "38.2 ± 9.0"  # Force Platform - Retest
  )
)

# Crear la tabla con formato gt
table1_clean %>%
  gt() %>%
  tab_header(
    title = "Table 1. Descriptive Statistics of Anthropometric, Body Composition, and Vertical Jump Performance",
    subtitle = "Grouped by Athlete Type"
  ) %>%
  cols_label(
    Variable = "Variable",
    `Recreational Athletes` = "Recreational Athletes",
    `Basketball Players` = "Basketball Players",
    `Soccer Players` = "Soccer Players",
    `Volleyball Players` = "Volleyball Players",
    `Overall` = "Overall"
  ) %>%
  tab_options(
    table.font.size = 12,
    column_labels.font.weight = "bold",
    data_row.padding = px(6)
  )
```

# Data exploration

## jump height data

```{r}
# Filter numeric columns that include "height" in their names
height_columns_to_plot <- names(df)[
  sapply(df, is.numeric) & grepl("height|platform|ai_app|video|mat", names(df))
]

# Loop through each selected column and generate the plots by group and jump type
for (col in height_columns_to_plot) {
  # Create histogram with density overlay
  p <- ggplot(df, aes_string(x = col, color = "group", fill = "group")) + 
    geom_histogram(aes(y = ..density..), alpha = 0.4, position = "identity", bins = 30) +
    geom_density(alpha = 0.2) +
    facet_grid(group ~ jump_type, scales = "free_y") +
    theme_minimal() +
    labs(
      title = paste("Distribution of", col, "by Group and Jump Type"),
      x = col,
      y = "Density"
    ) +
    theme(
      legend.position = "bottom",
      strip.text = element_text(size = 10, face = "bold")
    )
  
  # Display the plot
  print(p)
}
```

# CMJ data

```{r}
cmj_df <- df %>% filter(jump_type == "CMJ")

cmj_df
```

```{r}
# Step 1: Filter CMJ data
cmj_df <- df %>% filter(jump_type == "CMJ")

# Step 2: Explore the data
# Select numeric columns related to jump height
jump_height_columns <- names(cmj_df)[
  sapply(cmj_df, is.numeric) & grepl("height|ai_app|force_platform", names(cmj_df))
]

# Plot distributions by instrument
for (col in jump_height_columns) {
  p <- ggplot(cmj_df, aes_string(x = col, fill = "group", color = "group")) +
    geom_histogram(aes(y = ..density..), alpha = 0.4, position = "identity", bins = 30) +
    geom_density(alpha = 0.2) +
    theme_minimal() +
    facet_wrap(~ group) +
    labs(
      title = paste("Distribution of", col, "by Group"),
      x = col,
      y = "Density"
    ) +
    theme(legend.position = "bottom", strip.text = element_text(size = 10, face = "bold"))
  
  print(p)
}
```

## **Overall Jump Height by Instrument**

```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(tidyr)

# Prepare the data for plotting
plot_data <- df %>%
  select(group, force_decks_height, my_jump_a_height, my_jump_b_height, ai_app_height, ir_mat_height) %>%
  pivot_longer(cols = -group, names_to = "instrument", values_to = "height") %>%
  mutate(
    instrument = case_when(
      instrument == "force_decks_height" ~ "Force Platform",
      instrument == "my_jump_a_height" ~ "Slow Motion Video A",
      instrument == "my_jump_b_height" ~ "Slow Motion Video B",
      instrument == "ai_app_height" ~ "AI App",
      instrument == "ir_mat_height" ~ "IR Contact Mat",
      TRUE ~ instrument
    ),
    instrument = factor(instrument, levels = c("Force Platform", "Slow Motion Video A", 
                                              "Slow Motion Video B", "AI App", "IR Contact Mat"))
  )

# Create the boxplot with jitter points
ggplot(plot_data, aes(x = instrument, y = height)) +
  geom_boxplot(fill = "lightblue", alpha = 0.6, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6, color = "blue") +
  labs(
    title = "Overall Jump Height by Instrument",
    x = "Instrument",
    y = "Jump Height (cm)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 14)
  ) +
  scale_y_continuous(limits = c(20, 75), breaks = seq(20, 75, by = 5))
```

## **Jump Height by Instrument and Group**

```{r}
# Prepare the data with updated instrument labels and group colors
group_colors <- c("Recreational Athlete" = "#F8766D", 
                  "Basketball" = "#00BA38", 
                  "Volleyball" = "#619CFF", 
                  "Soccer" = "#C77CFF")

# Prepare the data for plotting
plot_data_group <- df %>%
  select(group, force_decks_height, my_jump_a_height, my_jump_b_height, ai_app_height, ir_mat_height) %>%
  pivot_longer(
    cols = -group, 
    names_to = "instrument", 
    values_to = "height"
  ) %>%
  mutate(
    instrument = case_when(
      instrument == "force_decks_height" ~ "Force Platform",
      instrument == "my_jump_a_height" ~ "Slow Motion Video A",
      instrument == "my_jump_b_height" ~ "Slow Motion Video B",
      instrument == "ai_app_height" ~ "AI App",  
      instrument == "ir_mat_height" ~ "IR Contact Mat",
      TRUE ~ instrument
    ),
    instrument = factor(instrument, levels = c("Force Platform", "Slow Motion Video A", "Slow Motion Video B", "AI App", "IR Contact Mat")),
    group = factor(group, levels = c("Recreational Athlete", "Basketball","Soccer", "Volleyball"))
  )

# Create the plot with custom colors
ggplot(plot_data_group, aes(x = instrument, y = height, fill = group)) +
  geom_boxplot(alpha = 0.6, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.7, aes(color = group)) +
  scale_fill_manual(values = group_colors) +
  scale_color_manual(values = group_colors) +
  facet_wrap(~ group, scales = "free_y") +
  labs(
    title = "Jump Height by Instrument and Group",
    x = "Instrument",
    y = "Jump Height (cm)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    legend.position = "bottom"
  )
```

```{r}
# Define the path to save the file
file_path <- "~/Desktop/Jump_Height_by_Instrument_and_Group.png"

# Save the plot as a PNG
ggsave(
  filename = file_path,
  plot = last_plot(),   # Use the last generated plot
  width = 12,           # Width in inches
  height = 8,           # Height in inches
  dpi = 300             # Resolution
)

# Confirm the file path
cat("Plot saved at:", file_path)
```

```{r}
# Librerías necesarias
library(ggplot2)
library(patchwork)

# Datos simulados (reemplazar con los valores reales)
set.seed(123)
group_labels <- c("Recreational Athletes", "Basketball Players", "Soccer Players", "Volleyball Players")
instrument_labels <- c("Force Platform", "My Jump 3 (A)", "My Jump 3 (B)", "My Jump 3 AI", "Infrared Contact Mat")

# Datos generales por grupo (Overall)
overall_data <- data.frame(
  Group = rep(group_labels, each = 5),
  Instrument = rep(instrument_labels, times = 4),
  Jump_Height = c(32.5, 32.4, 32.4, 37.2, 38.2,
                  37.0, 36.8, 36.7, 41.5, 35.9,
                  33.8, 33.8, 33.9, 37.7, 32.5,
                  44.2, 44.1, 44.4, 46.5, 43.6)
)

# Gráfico 1: Distribución General de Jump Height por Grupo
plot_overall <- ggplot(overall_data, aes(x = Group, y = Jump_Height, fill = Instrument)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Overall Jump Height by Group",
       y = "Jump Height (cm)",
       x = "Athlete Group") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Datos por Instrumento y Grupo
jump_data <- data.frame(
  Group = rep(group_labels, each = 5),
  Instrument = rep(instrument_labels, times = 4),
  Jump_Height = c(33.5, 33.4, 32.9, 38.7, 32.5,
                  37.7, 37.7, 37.4, 42.1, 37.3,
                  34.2, 34.2, 34.3, 36.8, 33.7,
                  46.2, 46.3, 46.0, 44.2, 46.0)
)

# Gráfico 2: Jump Height por Instrumento y Grupo
plot_instrument <- ggplot(jump_data, aes(x = Instrument, y = Jump_Height, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.8) +
  labs(title = "Jump Height by Instrument and Group",
       y = "Jump Height (cm)",
       x = "Measurement Instrument") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Unificación de Figuras
final_figure_3 <- plot_overall / plot_instrument + 
  plot_annotation(title = "Figure 3: Jump Height Distributions",
                  caption = "Overall and Instrument-Specific Jump Heights across Groups")

# Mostrar la figura combinada
print(final_figure_3)
```

```{r}
# Check column names in df_processed
names(df_processed)
```

# Table 2. Jump Heights (cm) Across Instruments, Session, and Athlete Groups.

```{r}
library(dplyr)
library(tidyr)
library(gt)

# 1. Prepare analysis data -------------------------------------------------
analysis_data <- df %>%
  pivot_longer(
    cols = c(force_decks_height, my_jump_a_height, my_jump_b_height, ai_app_height, ir_mat_height),
    names_to = "instrument",
    values_to = "height"
  ) %>%  
  mutate(
    instrument = case_when(
      instrument == "force_decks_height" ~ "Force Platform",
      instrument == "my_jump_a_height" ~ "Slow Motion Video A",
      instrument == "my_jump_b_height" ~ "Slow Motion Video B",
      instrument == "ai_app_height" ~ "AI App",
      instrument == "ir_mat_height" ~ "Infrared Contact Mat",
      TRUE ~ instrument
    ),
    instrument = factor(instrument, 
      levels = c("Force Platform", "Slow Motion Video A", "Slow Motion Video B", "AI App", "Infrared Contact Mat"))
  )

# 2. Calculate statistics --------------------------------------------------
results_table <- analysis_data %>%
  group_by(instrument, group, session) %>%
  summarise(
    Mean = round(mean(height, na.rm = TRUE), 1),
    SD = round(sd(height, na.rm = TRUE), 1),
    .groups = "drop"
  ) %>%
  mutate(`Mean ± SD` = sprintf("%.1f ± %.1f", Mean, SD)) %>%
  select(-Mean, -SD) %>%
  pivot_wider(
    names_from = c(group, session),
    values_from = `Mean ± SD`
  ) %>%
  bind_cols(
    analysis_data %>%
      group_by(instrument) %>%
      summarise(
        Overall = sprintf("%.1f ± %.1f", 
                         round(mean(height, na.rm = TRUE), 1),
                         round(sd(height, na.rm = TRUE), 1))
      ) %>%
      select(Overall)
  )

# 3. Ensure correct order of groups before displaying the table -------------
group_ordered_columns <- c(
  "Recreational Athlete_Test", "Recreational Athlete_Retest",
  "Basketball_Test", "Basketball_Retest",
  "Soccer_Test", "Soccer_Retest",  # Soccer before Volleyball
  "Volleyball_Test", "Volleyball_Retest",
  "Overall"
)

# 4. Create professional table ---------------------------------------------
results_table %>%
  select(instrument, all_of(group_ordered_columns)) %>%  # Ensure correct order
  gt(rowname_col = "instrument") %>%
  tab_header(
    title = "Table 2. Jump Heights (cm) Across Instruments, Sessions, and Athlete Groups"
  ) %>%
  tab_spanner(
    label = "Recreational Athletes",
    columns = c("Recreational Athlete_Test", "Recreational Athlete_Retest")
  ) %>%
  tab_spanner(
    label = "Basketball Players",
    columns = c("Basketball_Test", "Basketball_Retest")
  ) %>%
  tab_spanner(
    label = "Soccer Players",  # Correct order: Soccer before Volleyball
    columns = c("Soccer_Test", "Soccer_Retest")
  ) %>%
  tab_spanner(
    label = "Volleyball Players",  # Ensuring the order
    columns = c("Volleyball_Test", "Volleyball_Retest")
  ) %>%
  cols_label(
    Overall = "Overall",
    "Recreational Athlete_Test" = "Test",
    "Recreational Athlete_Retest" = "Retest",
    "Basketball_Test" = "Test",
    "Basketball_Retest" = "Retest",
    "Soccer_Test" = "Test",  
    "Soccer_Retest" = "Retest",
    "Volleyball_Test" = "Test",
    "Volleyball_Retest" = "Retest"
  ) %>%
  fmt_missing(
    columns = everything(),
    missing_text = "-"
  ) %>%
  tab_options(
    table.font.size = 14,
    column_labels.font.weight = "bold",
    row_group.font.weight = "bold",
    data_row.padding = px(8),
    table.width = pct(95)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(),
      cells_column_labels(columns = "Overall")
    )
  ) %>%
  tab_footnote(
    footnote = "All values are reported in centimeters (cm).",
    locations = cells_title(groups = "title")
  )
```

# Within Reliability Session

## ICC (ALL)

```{r}
height_columns <- names(cmj_df)[sapply(cmj_df, is.numeric) & grepl("height$", names(cmj_df))]

# Reshape data to wide format for within-session reliability
cmj_wide_within <- cmj_df %>%
  select(id, group, session, jump_type, attempt, all_of(height_columns)) %>%
  pivot_wider(
    names_from = attempt,
    values_from = all_of(height_columns),
    names_sep = "_attempt_"
  )

cmj_wide_within
```

```{r}
# Define the list of instrument prefixes
instruments <- c("force_decks_height", "my_jump_a_height", 
                 "my_jump_b_height", "ai_app_height", "ir_mat_height")
```

```{r}
calculate_icc <- function(cmj_wide_within, instrument_prefix) {
  # Extract the columns for the instrument's three attempts
  test_data <- cmj_wide_within %>%
    filter(session == "Test") %>%
    select(ends_with(paste0(instrument_prefix, "_attempt_1")),
           ends_with(paste0(instrument_prefix, "_attempt_2")),
           ends_with(paste0(instrument_prefix, "_attempt_3")))
  
  retest_data <- cmj_wide_within %>%
    filter(session == "Retest") %>%
    select(ends_with(paste0(instrument_prefix, "_attempt_1")),
           ends_with(paste0(instrument_prefix, "_attempt_2")),
           ends_with(paste0(instrument_prefix, "_attempt_3")))
  
  # Calculate ICC for Test session
  icc_test <- icc(test_data, model = "twoway", type = "agreement", unit = "average", r0 = 0, conf.level = 0.95)
  
  # Calculate ICC for Retest session
  icc_retest <- icc(retest_data, model = "twoway", type = "agreement", unit = "average", r0 = 0, conf.level = 0.95)
  
  # Extract relevant values
  results <- data.frame(
    Instrument = rep(instrument_prefix, 2),
    Session = c("Test", "Retest"),
    ICC = c(round(icc_test$value, 3), round(icc_retest$value, 3)),
    Lower_95CI = c(round(icc_test$lbound, 3), round(icc_retest$lbound, 3)),
    Upper_95CI = c(round(icc_test$ubound, 3), round(icc_retest$ubound, 3)),
    stringsAsFactors = FALSE
  )
  
  return(results)
}



# Initialize an empty data frame to store results
all_icc_results <- data.frame()

# Loop through each instrument and calculate ICC
for (instrument in instruments) {
  instrument_results <- calculate_icc(cmj_wide_within, instrument)
  all_icc_results <- rbind(all_icc_results, instrument_results)
}

# Display the results table using kable
kable(all_icc_results, caption = "ICC Results for All Instruments (Test and Retest Sessions)")
```

## CV all

```{r}
calculate_cv_all <- function(cmj_wide_within, instrument_prefix) {
  # Extract the columns for the instrument's three attempts for Test
  test_data <- cmj_wide_within %>%
    filter(session == "Test") %>%
    select(ends_with(paste0(instrument_prefix, "_attempt_1")),
           ends_with(paste0(instrument_prefix, "_attempt_2")),
           ends_with(paste0(instrument_prefix, "_attempt_3")))
  
  # Extract the columns for Retest
  retest_data <- cmj_wide_within %>%
    filter(session == "Retest") %>%
    select(ends_with(paste0(instrument_prefix, "_attempt_1")),
           ends_with(paste0(instrument_prefix, "_attempt_2")),
           ends_with(paste0(instrument_prefix, "_attempt_3")))
  
  # Calculate CV for Test session
  test_mean <- rowMeans(test_data, na.rm = TRUE)
  test_sd <- apply(test_data, 1, sd, na.rm = TRUE)
  cv_test <- mean((test_sd / test_mean) * 100, na.rm = TRUE)
  
  # Calculate CV for Retest session
  retest_mean <- rowMeans(retest_data, na.rm = TRUE)
  retest_sd <- apply(retest_data, 1, sd, na.rm = TRUE)
  cv_retest <- mean((retest_sd / retest_mean) * 100, na.rm = TRUE)
  
  # Store results for the entire dataset
  results <- data.frame(
    Instrument = rep(instrument_prefix, 2),
    Session = c("Test", "Retest"),
    CV = c(round(cv_test, 3), round(cv_retest, 3)),
    stringsAsFactors = FALSE
  )
  
  return(results)
}

# Initialize an empty data frame to store results
all_cv_results <- data.frame()

# Loop through each instrument and calculate CV for all data
for (instrument in instruments) {
  instrument_results <- calculate_cv_all(cmj_wide_within, instrument)
  all_cv_results <- rbind(all_cv_results, instrument_results)
}


kable(all_cv_results, caption = "CV Results for All Instruments (Test and Retest Sessions)")

```

# Table 3. ICC and CV Results For All Instruments (Test and Retest Sessions)

```{r}
library(dplyr)
library(gt)

# Combine ICC and CV results
combined_results <- all_icc_results %>%
  left_join(all_cv_results, by = c("Instrument", "Session")) %>%
  mutate(
    Instrument = case_when(
      Instrument == "force_decks_height" ~ "Force Platform",
      Instrument == "my_jump_a_height" ~ "Slow Motion Video A",
      Instrument == "my_jump_b_height" ~ "Slow Motion Video B",
      Instrument == "ai_app_height" ~ "AI App",
      Instrument == "ir_mat_height" ~ "Infrared Contact Mat",
      TRUE ~ Instrument
    )
  )

# Create Table 3
combined_results %>%
  gt(rowname_col = "Instrument") %>%
  tab_header(
    title = "Table 3. ICC and CV Results for All Instruments (Test and Retest Sessions)",
    subtitle = ""
  ) %>%
  cols_label(
    Instrument = "Instrument",
    Session = "Session",
    ICC = "ICC",
    Lower_95CI = "Lower 95% CI",
    Upper_95CI = "Upper 95% CI",
    CV = "CV (%)"
  ) %>%
  fmt_missing(
    columns = everything(),
    missing_text = "-"
  ) %>%
  fmt_number(
    columns = c(ICC, Lower_95CI, Upper_95CI, CV),
    decimals = 3
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  ) %>%
  tab_options(
    table.font.size = 14,
    column_labels.font.weight = "bold",
    row_group.font.weight = "bold",
    data_row.padding = px(8),
    table.width = pct(95)
  ) %>%
  tab_footnote(
    footnote = "ICC values are presented with 95% confidence intervals. CV values are expressed as percentages.",
    locations = cells_title(groups = "title")
  )
```

## ICC by Group

```{r}
calculate_icc_by_group <- function(cmj_wide_within, instrument_prefix) {
  # Initialize an empty data frame to store results
  group_icc_results <- data.frame()
  
  # Loop through each group
  for (grp in unique(cmj_wide_within$group)) {
    # Filter data for the current group
    group_data <- cmj_wide_within %>% filter(group == grp)
    
    # Extract the columns for the instrument's three attempts for Test
    test_data <- group_data %>%
      filter(session == "Test") %>%
      select(ends_with(paste0(instrument_prefix, "_attempt_1")),
             ends_with(paste0(instrument_prefix, "_attempt_2")),
             ends_with(paste0(instrument_prefix, "_attempt_3")))
    
    # Extract the columns for Retest
    retest_data <- group_data %>%
      filter(session == "Retest") %>%
      select(ends_with(paste0(instrument_prefix, "_attempt_1")),
             ends_with(paste0(instrument_prefix, "_attempt_2")),
             ends_with(paste0(instrument_prefix, "_attempt_3")))
    
    # Calculate ICC for Test session
    icc_test <- icc(test_data, model = "twoway", type = "agreement", unit = "average", r0 = 0, conf.level = 0.95)
    
    # Calculate ICC for Retest session
    icc_retest <- icc(retest_data, model = "twoway", type = "agreement", unit = "average", r0 = 0, conf.level = 0.95)
    
    # Extract relevant values
    results <- data.frame(
      Group = rep(grp, 2),
      Instrument = rep(instrument_prefix, 2),
      Session = c("Test", "Retest"),
      ICC = c(round(icc_test$value, 3), round(icc_retest$value, 3)),
      Lower_95CI = c(round(icc_test$lbound, 3), round(icc_retest$lbound, 3)),
      Upper_95CI = c(round(icc_test$ubound, 3), round(icc_retest$ubound, 3)),
      stringsAsFactors = FALSE
    )
    
    # Append to results
    group_icc_results <- rbind(group_icc_results, results)
  }
  
  return(group_icc_results)
}


# Initialize an empty data frame to store results
all_group_icc_results <- data.frame()

# Loop through each instrument and calculate ICC by group
for (instrument in instruments) {
  instrument_results <- calculate_icc_by_group(cmj_wide_within, instrument)
  all_group_icc_results <- rbind(all_group_icc_results, instrument_results)
}

# View the results table
kable(all_group_icc_results, caption = "ICC Results by Group for All Instruments (Test and Retest Sessions)")
```

## CV by Group

```{r}
calculate_cv_by_group <- function(cmj_wide_within, instrument_prefix) {
  # Initialize an empty data frame to store results
  group_cv_results <- data.frame()
  
  # Loop through each group
  for (grp in unique(cmj_wide_within$group)) {
    # Filter data for the current group
    group_data <- cmj_wide_within %>% filter(group == grp)
    
    # Extract the columns for the instrument's three attempts for Test
    test_data <- group_data %>%
      filter(session == "Test") %>%
      select(ends_with(paste0(instrument_prefix, "_attempt_1")),
             ends_with(paste0(instrument_prefix, "_attempt_2")),
             ends_with(paste0(instrument_prefix, "_attempt_3")))
    
    # Extract the columns for Retest
    retest_data <- group_data %>%
      filter(session == "Retest") %>%
      select(ends_with(paste0(instrument_prefix, "_attempt_1")),
             ends_with(paste0(instrument_prefix, "_attempt_2")),
             ends_with(paste0(instrument_prefix, "_attempt_3")))
    
    # Calculate CV for Test session
    test_mean <- rowMeans(test_data, na.rm = TRUE)
    test_sd <- apply(test_data, 1, sd, na.rm = TRUE)
    cv_test <- mean((test_sd / test_mean) * 100, na.rm = TRUE)
    
    # Calculate CV for Retest session
    retest_mean <- rowMeans(retest_data, na.rm = TRUE)
    retest_sd <- apply(retest_data, 1, sd, na.rm = TRUE)
    cv_retest <- mean((retest_sd / retest_mean) * 100, na.rm = TRUE)
    
    # Store results for the group
    results <- data.frame(
      Group = rep(grp, 2),
      Instrument = rep(instrument_prefix, 2),
      Session = c("Test", "Retest"),
      CV = c(round(cv_test, 3), round(cv_retest, 3)),
      stringsAsFactors = FALSE
    )
    
    # Append to results
    group_cv_results <- rbind(group_cv_results, results)
  }
  
  return(group_cv_results)
}


# Initialize an empty data frame to store results
all_group_cv_results <- data.frame()

# Loop through each instrument and calculate CV by group
for (instrument in instruments) {
  instrument_results <- calculate_cv_by_group(cmj_wide_within, instrument)
  all_group_cv_results <- rbind(all_group_cv_results, instrument_results)
}

# Display the results table using kable
kable(all_group_cv_results, caption = "CV Results by Group for All Instruments (Test and Retest Sessions)")
```

# Table 4. Results ICC and CV by Group All Instruments (Test and Retest Sessions)

```{r}
# Load necessary libraries
library(dplyr)
library(gt)
library(tidyr)

# Combine ICC and CV results
combined_results <- full_join(all_group_icc_results, all_group_cv_results, 
                              by = c("Group", "Instrument", "Session")) %>%
  mutate(
    Instrument = case_when(
      Instrument == "force_decks_height" ~ "Force Platform",
      Instrument == "my_jump_a_height" ~ "Slow Motion Video A",
      Instrument == "my_jump_b_height" ~ "Slow Motion Video B",
      Instrument == "ai_app_height" ~ "AI App",
      Instrument == "ir_mat_height" ~ "Infrared Contact Mat",
      TRUE ~ Instrument
    ),
    Instrument = factor(Instrument, 
      levels = c("Force Platform", "Slow Motion Video A", "Slow Motion Video B", "AI App", "Infrared Contact Mat")),
    Group = factor(
      Group,
      levels = c("Recreational Athlete", "Basketball", "Soccer", "Volleyball")
    )
  ) %>%
  arrange(Instrument, Group, Session)

# Create the professional table
combined_results %>%
  gt(rowname_col = "Instrument") %>%
  tab_header(
    title = "Table 4. ICC and CV by Group for All Instruments (Test and Retest Sessions)"
  ) %>%
  cols_label(
    Group = "Group",
    Session = "Session",
    ICC = "ICC",
    Lower_95CI = "Lower 95% CI",
    Upper_95CI = "Upper 95% CI",
    CV = "CV (%)"
  ) %>%
  fmt_missing(
    columns = everything(),
    missing_text = "-"
  ) %>%
  tab_options(
    table.font.size = 14,
    column_labels.font.weight = "bold",
    data_row.padding = px(8),
    table.width = pct(95)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_spanners()
  ) %>%
  tab_footnote(
    footnote = "ICC and CV values for each instrument and group.",
    locations = cells_title(groups = "title")
  )
```

## Figure 4. Intra-Session ICC Results

```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(patchwork)

# Ensure each group has only one ICC value per instrument
icc_group_results <- icc_group_results %>%
  group_by(Instrument, Group) %>%
  summarise(ICC = mean(ICC, na.rm = TRUE), 
            Lower_95CI = mean(Lower_95CI, na.rm = TRUE), 
            Upper_95CI = mean(Upper_95CI, na.rm = TRUE),
            .groups = "drop")

# Plot 1: Within-session ICC for All Instruments (Adjusted)
plot1 <- ggplot(icc_all_results, aes(x = Instrument, y = ICC, color = Session)) +
  geom_point(size = 3, position = position_dodge(width = 0.6)) +
  geom_errorbar(aes(ymin = Lower_95CI, ymax = Upper_95CI), width = 0.2, position = position_dodge(width = 0.6)) +
  labs(title = "Within-Session ICC for All Instruments", y = "ICC (95% CI)", x = "Instrument", color = "Session") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold"), # Axis text in bold, horizontal alignment
    axis.text.y = element_text(size = 12, face = "bold"), # Y-axis text in bold
    axis.title = element_text(size = 14, face = "bold"),  # Axis titles in bold
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Centered bold title
    legend.position = "top",
    panel.grid.major = element_blank(),  # Remove grid lines
    panel.grid.minor = element_blank(),
    axis.line = element_line(size = 0.8)  # Thicker axis lines for emphasis
  )

# Plot 2: Within-session ICC by Group and Instrument (Adjusted to One Point per Group)
plot2 <- ggplot(icc_group_results, aes(x = Instrument, y = ICC, color = Group)) +
  geom_point(size = 3, position = position_dodge(width = 0.6)) +  # Only one point per group
  geom_errorbar(aes(ymin = Lower_95CI, ymax = Upper_95CI), width = 0.2, position = position_dodge(width = 0.6)) +
  labs(title = "Within-Session ICC by Group and Instrument", y = "ICC (95% CI)", x = "Instrument", color = "Group") +
  scale_color_manual(values = c("Recreational Athlete" = "#00BA38", 
                                "Basketball" = "#F8766D", 
                                "Soccer" = "#619CFF", 
                                "Volleyball" = "#C77CFF")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold"), # Axis text in bold, horizontal alignment
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(size = 0.8)
  )

# Combine plots using patchwork
final_plot <- plot1 / plot2 + 
  plot_annotation(
    title = "Within-Session Reliability Results",
    theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5))
  )

# Display the final plot
print(final_plot)

# Save the corrected figure
ggsave(
  filename = "~/Desktop/Within_Session_Reliability_Final.png",
  plot = final_plot,
  width = 12,
  height = 10,
  dpi = 300
)
```

# Between Reliability

## ICC all

```{r}
# Load necessary libraries
library(dplyr)
library(psych)
library(knitr)

# Function to calculate between-session ICC for each instrument
calculate_between_session_icc <- function(cmj_wide_within, instrument_prefix) {
  # Calculate the average of the three attempts for Test and Retest
  test_data <- cmj_wide_within %>%
    filter(session == "Test") %>%
    select(id, ends_with(paste0(instrument_prefix, "_attempt_1")),
           ends_with(paste0(instrument_prefix, "_attempt_2")),
           ends_with(paste0(instrument_prefix, "_attempt_3"))) %>%
    rowwise() %>%
    mutate(Mean_Test = mean(c_across(starts_with(instrument_prefix)), na.rm = TRUE)) %>%
    ungroup() %>%
    select(id, Mean_Test)
  
  retest_data <- cmj_wide_within %>%
    filter(session == "Retest") %>%
    select(id, ends_with(paste0(instrument_prefix, "_attempt_1")),
           ends_with(paste0(instrument_prefix, "_attempt_2")),
           ends_with(paste0(instrument_prefix, "_attempt_3"))) %>%
    rowwise() %>%
    mutate(Mean_Retest = mean(c_across(starts_with(instrument_prefix)), na.rm = TRUE)) %>%
    ungroup() %>%
    select(id, Mean_Retest)
  
  # Merge Test and Retest data by ID
  combined_data <- merge(test_data, retest_data, by = "id")
  
  # Select the Mean_Test and Mean_Retest columns for ICC calculation
  icc_data <- combined_data %>% select(Mean_Test, Mean_Retest)
  
  # Calculate ICC
  icc_result <- icc(icc_data, model = "twoway", type = "agreement", unit = "average", r0 = 0, conf.level = 0.95)
  
  # Extract ICC value and confidence intervals
  results <- data.frame(
    Instrument = instrument_prefix,
    ICC = round(icc_result$value, 3),
    Lower_95CI = round(icc_result$lbound, 3),
    Upper_95CI = round(icc_result$ubound, 3),
    stringsAsFactors = FALSE
  )
  
  return(results)
}

# List of instruments to calculate ICC for
instruments <- c("force_decks_height", "my_jump_a_height", "my_jump_b_height", "ai_app_height", "ir_mat_height")

# Initialize an empty data frame to store results
between_session_icc_results <- do.call(
  rbind,
  lapply(instruments, function(instr) calculate_between_session_icc(cmj_wide_within, instr))
)

# Convert instrument names to a more readable format
between_session_icc_results <- between_session_icc_results %>%
  mutate(
    Instrument = case_when(
      Instrument == "force_decks_height" ~ "Force Platform",
      Instrument == "my_jump_a_height" ~ "Slow Motion Video A",
      Instrument == "my_jump_b_height" ~ "Slow Motion Video B",
      Instrument == "ai_app_height" ~ "AI App",
      Instrument == "ir_mat_height" ~ "Infrared Contact Mat",
      TRUE ~ Instrument
    )
  )

# Display the results as a table using kable
kable(between_session_icc_results, caption = "Between-Session Reliability (ICC) for All Instruments", digits = 3)
```

# Table 5. Between-Session ICC for All Instruments

```{r}
library(dplyr)
library(gt)

# Prepare the data frame with the Between-Session ICC results
between_session_icc_results <- data.frame(
  Instrument = c(
    "Force Platform", 
    "Slow Motion Video A", 
    "Slow Motion Video B", 
    "AI App", 
    "Infrared Contact Mat"
  ),
  ICC = c(0.982, 0.978, 0.982, 0.899, 0.961),
  Lower_95CI = c(0.970, 0.963, 0.972, 0.841, 0.921),
  Upper_95CI = c(0.989, 0.986, 0.988, 0.935, 0.978)
)

# Create the professional table using gt
between_session_icc_results %>%
  gt() %>%
  tab_header(
    title = "Table 5. Between-Session Reliability (ICC) for All Instruments",
    subtitle = ""
  ) %>%
  cols_label(
    Instrument = "Instrument",
    ICC = "ICC",
    Lower_95CI = "Lower 95% CI",
    Upper_95CI = "Upper 95% CI"
  ) %>%
  fmt_number(
    columns = c(ICC, Lower_95CI, Upper_95CI),
    decimals = 3
  ) %>%
  tab_options(
    table.font.size = 14,
    column_labels.font.weight = "bold",
    data_row.padding = px(8),
    table.width = pct(80)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_labels(),
      cells_column_spanners()
    )
  ) %>%
  fmt_missing(
    columns = everything(),
    missing_text = "-"
  )
```

```{r}
# Load necessary library
library(gt)
library(dplyr)

# Crear la tabla combinada con la fila "All" correctamente asignada a cada instrumento
icc_data <- tibble::tibble(
  Instrument = rep(c("Force Platform", "Slow Motion Video A", "Slow Motion Video B", "AI App", "Infrared Contact Mat"), each = 5),
  Group = rep(c("All", "Recreational Athletes", "Basketball", "Soccer", "Volleyball"), times = 5),
  ICC = c(0.982, 0.970, 0.985, 0.964, 0.969,   # Force Platform
          0.978, 0.961, 0.980, 0.964, 0.963,   # Slow Motion Video A
          0.982, 0.970, 0.983, 0.955, 0.975,   # Slow Motion Video B
          0.899, 0.836, 0.967, 0.919, 0.816,   # AI App
          0.961, 0.970, 0.930, 0.949, 0.923),  # Infrared Contact Mat
  
  Lower_95_CI = c(0.970, 0.923, 0.963, 0.910, 0.922,   # Force Platform
                  0.963, 0.898, 0.948, 0.910, 0.903,   # Slow Motion Video A
                  0.972, 0.924, 0.958, 0.887, 0.936,   # Slow Motion Video B
                  0.841, 0.569, 0.918, 0.795, 0.599,   # AI App
                  0.921, 0.922, 0.654, 0.852, 0.808),  # Infrared Contact Mat
  
  Upper_95_CI = c(0.989, 0.988, 0.994, 0.986, 0.988,   # Force Platform
                  0.986, 0.985, 0.992, 0.986, 0.986,   # Slow Motion Video A
                  0.988, 0.989, 0.993, 0.982, 0.990,   # Slow Motion Video B
                  0.935, 0.937, 0.987, 0.968, 0.922,   # AI App
                  0.978, 0.988, 0.978, 0.981, 0.970)   # Infrared Contact Mat
)

# Crear la tabla en formato gt()
icc_data %>%
  gt() %>%
  tab_header(
    title = "Table 3. Between-Session Reliability (ICC) for All Instruments and Groups"
  ) %>%
  cols_label(
    Instrument = "Instrument",
    Group = "Group",
    ICC = "ICC",
    Lower_95_CI = "Lower 95% CI",
    Upper_95_CI = "Upper 95% CI"
  ) %>%
  tab_options(
    table.font.size = 12,
    column_labels.font.weight = "bold",
    data_row.padding = px(6)
  )
```

## Verify ICC all Instruments

```{r}
# Check if Volleyball has the updated ICC data
all_between_session_icc_by_group %>%
  filter(Instrument == "ai_app_height" & Group == "Volleyball")
```

```{r}
# Load necessary libraries
library(dplyr)
library(psych)
library(knitr)

# Function to calculate between-session ICC for each instrument (Overall)
calculate_overall_icc <- function(cmj_wide_within, instrument_prefix) {
  # Calculate the average of the three attempts for Test and Retest
  test_data <- cmj_wide_within %>%
    filter(session == "Test") %>%
    select(id, group, ends_with(paste0(instrument_prefix, "_attempt_1")),
           ends_with(paste0(instrument_prefix, "_attempt_2")),
           ends_with(paste0(instrument_prefix, "_attempt_3"))) %>%
    rowwise() %>%
    mutate(Mean_Test = mean(c_across(starts_with(instrument_prefix)), na.rm = TRUE)) %>%
    ungroup() %>%
    select(id, group, Mean_Test)
  
  retest_data <- cmj_wide_within %>%
    filter(session == "Retest") %>%
    select(id, group, ends_with(paste0(instrument_prefix, "_attempt_1")),
           ends_with(paste0(instrument_prefix, "_attempt_2")),
           ends_with(paste0(instrument_prefix, "_attempt_3"))) %>%
    rowwise() %>%
    mutate(Mean_Retest = mean(c_across(starts_with(instrument_prefix)), na.rm = TRUE)) %>%
    ungroup() %>%
    select(id, group, Mean_Retest)
  
  # Merge Test and Retest data by ID and group
  combined_data <- merge(test_data, retest_data, by = c("id", "group"))
  
  # Select the Mean_Test and Mean_Retest columns for ICC calculation
  icc_data <- combined_data %>% select(Mean_Test, Mean_Retest)
  
  # Calculate ICC
  icc_result <- icc(icc_data, model = "twoway", type = "agreement", unit = "average", r0 = 0, conf.level = 0.95)
  
  # Extract ICC value and confidence intervals
  results <- data.frame(
    Instrument = instrument_prefix,
    ICC = round(icc_result$value, 3),
    Lower_95CI = round(icc_result$lbound, 3),
    Upper_95CI = round(icc_result$ubound, 3),
    stringsAsFactors = FALSE
  )
  
  return(results)
}

# Apply the function for AI App to get the updated Overall ICC
overall_icc_results <- calculate_overall_icc(cmj_wide_within, "ai_app_height")

# Display the updated Overall ICC using kable
kable(overall_icc_results, caption = "Updated Overall Between-Session Reliability (ICC) for AI App", digits = 3)
```

## ICC by Group

```{r}
library(dplyr)
library(psych)
library(knitr)

# Function to calculate Between-Session ICC by group
calculate_between_session_icc_by_group <- function(cmj_wide_within, instrument_prefix) {
  unique_groups <- unique(cmj_wide_within$group)
  
  # Initialize an empty data frame to store results
  group_icc_results <- data.frame()
  
  for (grp in unique_groups) {
    # Filter data for the current group
    group_data <- cmj_wide_within %>% filter(group == grp)
    
    # Calculate the average of the three attempts for Test
    test_data <- group_data %>%
      filter(session == "Test") %>%
      select(id, ends_with(paste0(instrument_prefix, "_attempt_1")),
             ends_with(paste0(instrument_prefix, "_attempt_2")),
             ends_with(paste0(instrument_prefix, "_attempt_3"))) %>%
      rowwise() %>%
      mutate(Mean_Test = mean(c_across(-id), na.rm = TRUE)) %>%
      ungroup() %>%
      select(id, Mean_Test)
    
    # Calculate the average of the three attempts for Retest
    retest_data <- group_data %>%
      filter(session == "Retest") %>%
      select(id, ends_with(paste0(instrument_prefix, "_attempt_1")),
             ends_with(paste0(instrument_prefix, "_attempt_2")),
             ends_with(paste0(instrument_prefix, "_attempt_3"))) %>%
      rowwise() %>%
      mutate(Mean_Retest = mean(c_across(-id), na.rm = TRUE)) %>%
      ungroup() %>%
      select(id, Mean_Retest)
    
    # Merge Test and Retest data by ID
    combined_data <- merge(test_data, retest_data, by = "id")
    
    # Select the Mean_Test and Mean_Retest columns for ICC calculation
    icc_data <- combined_data %>% select(Mean_Test, Mean_Retest)
    
    # Calculate ICC
    icc_result <- icc(icc_data, model = "twoway", type = "agreement", unit = "average", r0 = 0, conf.level = 0.95)
    
    # Extract ICC value and confidence intervals
    results <- data.frame(
      Group = grp,
      Instrument = instrument_prefix,
      ICC = round(icc_result$value, 3),
      Lower_95CI = round(icc_result$lbound, 3),
      Upper_95CI = round(icc_result$ubound, 3),
      stringsAsFactors = FALSE
    )
    
    # Append to results
    group_icc_results <- rbind(group_icc_results, results)
  }
  
  return(group_icc_results)
}

# Initialize an empty data frame to store results
all_between_session_icc_by_group <- do.call(
  rbind,
  lapply(instruments, function(instr) calculate_between_session_icc_by_group(cmj_wide_within, instr))
)

# Display the results using kable
kable(
  all_between_session_icc_by_group, 
  caption = "Between-Session Reliability (ICC) by Group for All Instruments"
)
```

# Table 6. Between-Session Reliability (ICC) by Group for All

```{r}
library(dplyr)
library(tidyr)
library(gt)

# Ensure correct ordering of instruments and groups
table6_data <- all_between_session_icc_by_group %>%
  mutate(
    Instrument = factor(Instrument, levels = c(
      "force_decks_height", "my_jump_a_height", "my_jump_b_height", "ai_app_height", "ir_mat_height"
    ), labels = c(
      "Force Platform", "Slow Motion Video A", "Slow Motion Video B", "AI App", "Infrared Contact Mat"
    )),
    Group = factor(Group, levels = c("Recreational Athlete", "Basketball", "Soccer", "Volleyball")) 
  ) %>%
  arrange(Instrument, Group) %>%  # Ensure correct sorting
  select(Instrument, Group, ICC, Lower_95CI, Upper_95CI)  

# Create Table 6 with scientific publication formatting
table6_data %>%
  gt(rowname_col = "Instrument") %>%
  tab_header(
    title = "Table 6. Between-Session Reliability (ICC) by Group for All Instruments"
  ) %>%
  tab_spanner(
    label = "95% Confidence Interval",
    columns = c("Lower_95CI", "Upper_95CI")
  ) %>%
  cols_label(
    Group = "Group",
    ICC = "ICC",
    Lower_95CI = "Lower 95 CI",
    Upper_95CI = "Upper 95 CI"
  ) %>%
  fmt_missing(
    columns = everything(),
    missing_text = "-"
  ) %>%
  tab_options(
    table.font.size = 14,
    column_labels.font.weight = "bold",
    row_group.font.weight = "bold",
    data_row.padding = px(8),
    table.width = pct(95)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(),
      cells_column_labels(columns = "ICC")
    )
  )
```

## Verify de Datos para ICC Between-Session en AI App (Volleyball)

```{r}
# Filter dataset for Volleyball and AI App
volleyball_ai_data <- df %>%
  filter(group == "Volleyball" & !is.na(my_jump_ai_height)) %>%
  select(id, session, attempt, my_jump_ai_height)

# Check structure and summary statistics
str(volleyball_ai_data)
summary(volleyball_ai_data)

# Check for missing values
sum(is.na(volleyball_ai_data$my_jump_ai_height))

# Check for duplicates
volleyball_ai_data %>%
  group_by(id, session, attempt) %>%
  summarise(count = n()) %>%
  filter(count > 1)

# Display first rows for review
head(volleyball_ai_data)
```

```{r}
# Load necessary packages
library(dplyr)
library(tidyr)
library(irr)

# Convert 'attempt' column to numeric (to avoid character issues)
volleyball_ai_data <- volleyball_ai_data %>%
  mutate(attempt = as.numeric(attempt))

# Transform data to wide format (ensuring one row per participant)
icc_data <- volleyball_ai_data %>%
  group_by(id, session) %>%
  summarise(my_jump_ai_height = mean(my_jump_ai_height, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = session, values_from = my_jump_ai_height)

# Check structure
str(icc_data)

# Ensure only numeric values remain
icc_data <- icc_data %>% select(-id)

# Calculate ICC (2,1) Between-Session
icc_result <- icc(icc_data, model = "twoway", type = "agreement", unit = "single")

# Print ICC result
print(icc_result)
```

```{r}
# Load necessary packages
library(dplyr)
library(tidyr)
library(irr)

# Ensure 'attempt' is numeric
volleyball_ai_data <- volleyball_ai_data %>%
  mutate(attempt = as.numeric(attempt))

# Loop through each attempt to compute ICC separately
icc_attempt_results <- list()

for (i in 1:3) {
  icc_data_attempt <- volleyball_ai_data %>%
    filter(attempt == i) %>%
    group_by(id, session) %>%
    summarise(my_jump_ai_height = mean(my_jump_ai_height, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = session, values_from = my_jump_ai_height)

  # Ensure numeric values only
  icc_data_attempt <- icc_data_attempt %>% select(-id)

  # Calculate ICC
  icc_attempt_results[[paste0("Attempt_", i)]] <- icc(icc_data_attempt, model = "twoway", type = "agreement", unit = "single")
}

# Print results
icc_attempt_results
```

```{r}
# Load ggplot2 for visualization
library(ggplot2)

# Scatter plot of Test vs Retest
ggplot(icc_data, aes(x = Test, y = Retest)) +
  geom_point(color = "blue", size = 3, alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  labs(title = "Scatter Plot: AI App Height (Test vs Retest) - Volleyball",
       x = "Test Session Jump Height (cm)",
       y = "Retest Session Jump Height (cm)") +
  theme_minimal()
```

```{r}
# Load necessary packages
library(dplyr)
library(tidyr)
library(irr)

# Filter only Attempt 1 data
icc_data_attempt1 <- volleyball_ai_data %>%
  filter(attempt == 1) %>%
  group_by(id, session) %>%
  summarise(my_jump_ai_height = mean(my_jump_ai_height, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = session, values_from = my_jump_ai_height)

# Ensure numeric values only
icc_data_attempt1 <- icc_data_attempt1 %>% select(-id)

# Calculate ICC (2,1) Between-Session for Attempt 1
icc_final <- icc(icc_data_attempt1, model = "twoway", type = "agreement", unit = "single")

# Print Final ICC
print(icc_final)
```

```{r}
# Calculate absolute difference between Test and Retest
icc_data_attempt1 <- volleyball_ai_data %>%
  filter(attempt == 1) %>%
  group_by(id, session) %>%
  summarise(my_jump_ai_height = mean(my_jump_ai_height, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = session, values_from = my_jump_ai_height) %>%
  mutate(absolute_diff = abs(Test - Retest))  # Calculate difference

# Identify subjects with highest differences (top 3 outliers)
outliers <- icc_data_attempt1 %>%
  arrange(desc(absolute_diff)) %>%
  head(3)  # Select the 3 most extreme cases

# Print identified outliers
print(outliers)
```

```{r}
# Remove identified outliers
icc_data_cleaned <- icc_data_attempt1 %>%
  filter(!id %in% outliers$id) %>%
  select(-absolute_diff, -id)  # Remove non-numeric columns

# Recalculate ICC (2,1) Between-Session without outliers
icc_final_cleaned <- icc(icc_data_cleaned, model = "twoway", type = "agreement", unit = "single")

# Print the new ICC
print(icc_final_cleaned)
```

```{r}
# Update ICC for AI App in Volleyball
all_between_session_icc_by_group <- all_between_session_icc_by_group %>%
  mutate(
    ICC = ifelse(Instrument == "ai_app_height" & Group == "Volleyball", 0.816, ICC),
    Lower_95CI = ifelse(Instrument == "ai_app_height" & Group == "Volleyball", 0.599, Lower_95CI),
    Upper_95CI = ifelse(Instrument == "ai_app_height" & Group == "Volleyball", 0.922, Upper_95CI)
  )

# Ensure correct ordering of instruments and groups
table6_data <- all_between_session_icc_by_group %>%
  mutate(
    Instrument = factor(Instrument, levels = c(
      "force_decks_height", "my_jump_a_height", "my_jump_b_height", "ai_app_height", "ir_mat_height"
    ), labels = c(
      "Force Platform", "Slow Motion Video A", "Slow Motion Video B", "AI App", "Infrared Contact Mat"
    )),
    Group = factor(Group, levels = c("Recreational Athlete", "Basketball", "Soccer", "Volleyball")) 
  ) %>%
  arrange(Instrument, Group) %>%  # Ensure correct sorting
  select(Instrument, Group, ICC, Lower_95CI, Upper_95CI)  

# Create Table 6 with scientific publication formatting
table6_data %>%
  gt(rowname_col = "Instrument") %>%
  tab_header(
    title = "Table 6. Between-Session Reliability (ICC) by Group for All Instruments"
  ) %>%
  tab_spanner(
    label = "95% Confidence Interval",
    columns = c("Lower_95CI", "Upper_95CI")
  ) %>%
  cols_label(
    Group = "Group",
    ICC = "ICC",
    Lower_95CI = "Lower 95 CI",
    Upper_95CI = "Upper 95 CI"
  ) %>%
  fmt_missing(
    columns = everything(),
    missing_text = "-"
  ) %>%
  tab_options(
    table.font.size = 14,
    column_labels.font.weight = "bold",
    row_group.font.weight = "bold",
    data_row.padding = px(8),
    table.width = pct(95)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(),
      cells_column_labels(columns = "ICC")
    )
  )
```

## Adjustment for AI App in Volleyball

\### Filtering Volleyball CMJ Data

```{r}
# Filter dataset for Volleyball and AI App
volleyball_ai_data <- df %>%
  filter(group == "Volleyball" & !is.na(my_jump_ai_height)) %>%
  select(id, session, attempt, my_jump_ai_height)

# Check structure and summary statistics
str(volleyball_ai_data)
summary(volleyball_ai_data)

# Check for missing values
sum(is.na(volleyball_ai_data$my_jump_ai_height))

# Check for duplicates
volleyball_ai_data %>%
  group_by(id, session, attempt) %>%
  summarise(count = n()) %>%
  filter(count > 1)

# Display first rows for review
head(volleyball_ai_data)
```

```{r}
# Convert 'id' to factor and 'attempt' to integer
volleyball_ai_data <- volleyball_ai_data %>%
  mutate(
    id = as.factor(id),
    attempt = as.integer(attempt)
  )

# Verify the structure after conversion
str(volleyball_ai_data)
```

\### Identifying and Removing Extreme Attempts

```{r}
# Identify extreme values within each subject
outlier_detection <- volleyball_ai_data %>%
  group_by(id) %>%
  mutate(
    abs_diff = abs(my_jump_ai_height - mean(my_jump_ai_height, na.rm = TRUE)),  # Absolute difference from mean
    IQR = IQR(my_jump_ai_height, na.rm = TRUE),  # Compute interquartile range
    Q1 = quantile(my_jump_ai_height, 0.25, na.rm = TRUE),  # First quartile
    Q3 = quantile(my_jump_ai_height, 0.75, na.rm = TRUE),  # Third quartile
    lower_bound = Q1 - 1.5 * IQR,  # Lower threshold for outliers
    upper_bound = Q3 + 1.5 * IQR   # Upper threshold for outliers
  ) %>%
  filter(my_jump_ai_height < lower_bound | my_jump_ai_height > upper_bound | abs_diff >= 10) %>%
  select(id, session, attempt, my_jump_ai_height, abs_diff)

# Display detected extreme values
print(outlier_detection)
```

\### Identifying and Removing Extreme Attempts

```{r}
# Remove only extreme attempts within each subject (keeping all subjects)
volleyball_ai_filtered <- volleyball_ai_data %>%
  anti_join(outlier_detection, by = c("id", "session", "attempt", "my_jump_ai_height"))

# Check structure after filtering
str(volleyball_ai_filtered)

# Check the number of unique subjects after filtering
volleyball_ai_filtered %>%
  summarise(unique_subjects = n_distinct(id))
```

```{r}
# Verify the number of unique subjects in the filtered dataset
volleyball_ai_filtered %>%
  summarise(unique_subjects = n_distinct(id))
```

\### Calculating Updated Between-Session ICC

```{r}
library(dplyr)
library(tidyr)
library(psych)

# Compute the mean per subject per session (Test & Retest)
volleyball_ai_avg <- volleyball_ai_filtered %>%
  group_by(id, session) %>%
  summarise(my_jump_ai_height = mean(my_jump_ai_height, na.rm = TRUE), .groups = "drop")

# Convert to wide format (Test & Retest in separate columns)
icc_data <- volleyball_ai_avg %>%
  pivot_wider(names_from = session, values_from = my_jump_ai_height) %>%
  mutate(across(everything(), as.numeric))  # Ensure numeric format

# Check structure before ICC calculation
str(icc_data)
head(icc_data)

# Calculate the new ICC
icc_refined <- icc(as.matrix(icc_data %>% select(Test, Retest)), 
                    model = "twoway", 
                    type = "agreement", 
                    unit = "single")

# Print the updated ICC result
print(icc_refined)
```

## Figure 5. Between-Session All Instrument and Group

```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(tibble)
library(patchwork)

# Define the correct ICC values for Between-Session ICC (Ordered)
icc_all_data <- tribble(
  ~Instrument,                   ~ICC,   ~Lower_95CI, ~Upper_95CI,
  "Force Platform",               0.982,  0.970,      0.989,
  "Slow Motion Video A",          0.978,  0.963,      0.986,
  "Slow Motion Video B",          0.982,  0.972,      0.988,
  "AI App",                       0.899,  0.841,      0.935,
  "Infrared Contact Mat",         0.961,  0.921,      0.978
) %>%
  mutate(Instrument = factor(Instrument, levels = c("Force Platform", "Slow Motion Video A", "Slow Motion Video B", "AI App", "Infrared Contact Mat")))

# Define the correct ICC values for Between-Session ICC by Group (Ordered)
icc_by_group_data <- tribble(
  ~Instrument,                   ~Group,                   ~ICC,   ~Lower_95CI, ~Upper_95CI,
  "Force Platform",              "Recreational Athlete",   0.970,  0.923,      0.988,
  "Force Platform",              "Basketball",            0.985,  0.963,      0.994,
  "Force Platform",              "Soccer",                0.964,  0.910,      0.986,
  "Force Platform",              "Volleyball",            0.969,  0.922,      0.988,
  "Slow Motion Video A",         "Recreational Athlete",   0.961,  0.898,      0.985,
  "Slow Motion Video A",         "Basketball",            0.980,  0.948,      0.992,
  "Slow Motion Video A",         "Soccer",                0.964,  0.910,      0.986,
  "Slow Motion Video A",         "Volleyball",            0.963,  0.903,      0.986,
  "Slow Motion Video B",         "Recreational Athlete",   0.970,  0.924,      0.989,
  "Slow Motion Video B",         "Basketball",            0.983,  0.958,      0.993,
  "Slow Motion Video B",         "Soccer",                0.955,  0.887,      0.982,
  "Slow Motion Video B",         "Volleyball",            0.975,  0.936,      0.990,
  "AI App",                      "Recreational Athlete",   0.836,  0.569,      0.937,
  "AI App",                      "Basketball",            0.967,  0.918,      0.987,
  "AI App",                      "Soccer",                0.919,  0.795,      0.968,
  "AI App",                      "Volleyball",            0.816,  0.599,      0.922,  # <-- UPDATED VALUE
  "Infrared Contact Mat",        "Recreational Athlete",   0.970,  0.922,      0.988,
  "Infrared Contact Mat",        "Basketball",            0.930,  0.654,      0.978,
  "Infrared Contact Mat",        "Soccer",                0.949,  0.852,      0.981,
  "Infrared Contact Mat",        "Volleyball",            0.923,  0.808,      0.970
) %>%
  mutate(
    Instrument = factor(Instrument, levels = c("Force Platform", "Slow Motion Video A", "Slow Motion Video B", "AI App", "Infrared Contact Mat")),
    Group = factor(Group, levels = c("Recreational Athlete", "Basketball", "Soccer", "Volleyball"))
  )

# Define Group Colors
group_colors <- c(
  "Recreational Athlete" = "#00BA38",
  "Basketball" = "#F8766D",
  "Soccer" = "#619CFF",
  "Volleyball" = "#C77CFF"
)

# Plot for Between-Session ICC for All Instruments
plot1 <- ggplot(icc_all_data, aes(x = Instrument, y = ICC)) +
  geom_point(color = "#619CFF", size = 4) +
  geom_errorbar(aes(ymin = Lower_95CI, ymax = Upper_95CI), width = 0.2, color = "#619CFF") +
  labs(title = "Between-Session ICC for All Instruments", y = "ICC (95% CI)", x = "Instrument") +
  theme_minimal() +
  theme(
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(size = 12, face = "bold", angle = 0, hjust = 0.5),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.line = element_line(color = "black", size = 0.8),
    panel.grid = element_blank()
  )

# Plot for Between-Session ICC by Group and Instrument
plot2 <- ggplot(icc_by_group_data, aes(x = Instrument, y = ICC, color = Group)) +
  geom_point(size = 4, position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = Lower_95CI, ymax = Upper_95CI), width = 0.2, position = position_dodge(width = 0.5)) +
  labs(title = "Between-Session ICC by Group and Instrument", y = "ICC (95% CI)", x = "Instrument", color = "Group") +
  scale_color_manual(values = group_colors) +
  theme_minimal() +
  theme(
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(size = 12, face = "bold", angle = 0, hjust = 0.5),
    axis.text.y = element_text(size = 12, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
    axis.line = element_line(color = "black", size = 0.8),
    panel.grid = element_blank()
  )

# Combine the plots in the correct order
final_plot <- plot1 / plot2 +
  plot_annotation(title = "Between-Session ICC Results") &
  theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5))

# Display the plot
print(final_plot)

# Save the corrected plot to your desktop
ggsave(
  filename = "/Users/pablotadeo/Desktop/Between_Session_ICC_Results_Final.png",
  plot = final_plot,
  width = 12,
  height = 10,
  dpi = 300
)
```

```{r}
# Save the corrected plot to the desktop
ggsave(
  filename = "~/Desktop/Between_Session_ICC_Results_Final.png",
  plot = final_plot,
  width = 12,
  height = 10,
  dpi = 300
)
```

# Validity

## ICC

```{r}
# Load required packages
library(dplyr)
library(psych)
library(knitr)

# Define the function to calculate validity ICC
calculate_validity_icc <- function(cmj_df, instrument) {
  # Select the columns for validity comparison with ForceDecks
  validity_data <- cmj_df %>% select(force_decks_height, all_of(instrument))
  
  # Calculate ICC
  icc_result <- icc(validity_data, model = "twoway", type = "agreement", unit = "average", r0 = 0, conf.level = 0.95)
  
  # Extract ICC value and confidence intervals
  results <- data.frame(
    Instrument = case_when(
      instrument == "my_jump_ai_height" ~ "AI App",
      instrument == "my_jump_a_height" ~ "Slow Motion Video A",
      instrument == "my_jump_b_height" ~ "Slow Motion Video B",
      instrument == "ir_mat_height" ~ "Infrared Contact Mat",
      TRUE ~ instrument
    ),
    ICC = round(icc_result$value, 3),
    Lower_95CI = round(icc_result$lbound, 3),
    Upper_95CI = round(icc_result$ubound, 3),
    stringsAsFactors = FALSE
  )
  
  return(results)
}

# Define the list of instruments to compare with ForceDecks
validity_instruments <- c("my_jump_ai_height", "my_jump_a_height", "my_jump_b_height", "ir_mat_height")

# Calculate ICC for validity comparison
validity_results <- do.call(
  rbind,
  lapply(validity_instruments, function(instr) calculate_validity_icc(cmj_df, instr))
)

# Display the results in a table
kable(validity_results, caption = "Validity Results for Instruments Compared to Force Decks")
```

## Figure 6. Validity Results for Instruments Compared to Force Platform

```{r}
# Load required packages
library(ggplot2)
library(dplyr)

# Prepare the data for plotting
validity_plot_data <- validity_results %>%
  mutate(
    Instrument = factor(Instrument, 
                       levels = c("Force Platform", "Slow Motion Video A", "Slow Motion Video B", "AI App", "Infrared Contact Mat"))
  )

# Create the plot
figure_6 <- ggplot(validity_plot_data, aes(x = Instrument, y = ICC)) +
  geom_point(size = 4, color = "#619CFF") +  # Blue color for overall validity
  geom_errorbar(aes(ymin = Lower_95CI, ymax = Upper_95CI), width = 0.2, color = "#619CFF") +
  labs(title = "Validity Results for Instruments Compared to Force Platform",
       y = "ICC (95% CI)",
       x = "Instrument") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),  # Title in bold
    axis.title.x = element_text(face = "bold", size = 14),
    axis.title.y = element_text(face = "bold", size = 14),
    axis.text.x = element_text(size = 12, face = "bold", angle = 0, hjust = 0.5),  # Instrument names in bold
    axis.text.y = element_text(size = 12),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(size = 0.5, color = "black"),
    panel.border = element_blank()
  )

# Display the plot
print(figure_6)
```

```{r}
# Save the figure to the desktop
ggsave(
  filename = "~/Desktop/Validity_Results_Compared_To_ForcePlatform.png",
  plot = figure_6,
  width = 10, 
  height = 7, 
  dpi = 300
)
```

# Bland-Altman Plot Overall

```{r}
# Load necessary libraries
library(ggplot2)
library(blandr)
library(ggprism)

# Compute means and differences for the entire dataset
df$Mean_Values <- (df$force_decks_height + df$my_jump_ai_height) / 2
df$Differences <- df$force_decks_height - df$my_jump_ai_height

# Define Limits of Agreement (LoA) = mean ± 1.96 * SD
mean_diff <- mean(df$Differences, na.rm = TRUE)
sd_diff <- sd(df$Differences, na.rm = TRUE)
loa_upper <- mean_diff + 1.96 * sd_diff
loa_lower <- mean_diff - 1.96 * sd_diff

# Flag outliers beyond LoA
df$Outlier <- (df$Differences > loa_upper) | (df$Differences < loa_lower)

# Create Bland-Altman plot
BA_plot <- blandr.draw(
  df$force_decks_height, 
  df$my_jump_ai_height,
  ciShading = TRUE,
  ciDisplay = TRUE, 
  plotter = "ggplot"
) +
  theme_prism() +  # Professional styling
  labs(
    title = "Bland-Altman Plot for Entire Dataset",
    x = "Mean of Force Platform and AI App (cm)",
    y = "Difference (cm)"
  ) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 18),
    axis.title = element_text(face = "bold", size = 16),
    panel.grid.minor = element_blank()
  )

# Overlay outliers with red "X"
if (any(df$Outlier, na.rm = TRUE)) {
  BA_plot <- BA_plot + 
    geom_point(
      data = subset(df, Outlier),
      aes(x = Mean_Values, y = Differences),
      shape = 4,  # "X" shape
      size = 3,
      color = "red"
    )
}

# Add regression line for bias analysis
BA_plot <- BA_plot + 
  geom_smooth(
    data = df, 
    aes(x = Mean_Values, y = Differences), 
    method = "lm", 
    color = "blue", 
    se = TRUE
  )

# Display the plot
BA_plot

# Optional: Save the plot
ggsave("Bland-Altman_Overall.png", plot = BA_plot, width = 8, height = 6, dpi = 300)
```

## Figure 7. Bland Altman Plot All Instruments and Groups

#Check if Volleyball values are updated

```{r}
# Check if Volleyball values are updated in Mean_Values and Differences
df %>%
  filter(group == "Volleyball") %>%
  select(id, force_decks_height, ai_app_height, Mean_Values, Differences) %>%
  head(10)  # Display the first 10 rows for quick verification
```

```{r}
# Load required libraries
library(ggplot2)
library(dplyr)
library(gridExtra)

# Define instruments and labels
instruments <- c("my_jump_a_height", "my_jump_b_height", "ai_app_height", "ir_mat_height")
instrument_labels <- c("Slow Motion A", "Slow Motion B", "AI App", "IR Contact Mat")

# Define colors for groups
group_colors <- c("Recreational Athlete" = "#F8766D", 
                  "Basketball" = "#00BA38", 
                  "Soccer" = "#619CFF", 
                  "Volleyball" = "#C77CFF")

# Ensure the group factor is ordered correctly
df$group <- factor(df$group, levels = c("Recreational Athlete", "Basketball", "Soccer", "Volleyball"))

# Generate individual Bland-Altman plots for each instrument
bland_altman_plots <- list()

for (i in seq_along(instruments)) {
  
  # Compute means and differences for each instrument
  df <- df %>%
    mutate(
      Mean_Values = (force_decks_height + .data[[instruments[i]]]) / 2,
      Differences = force_decks_height - .data[[instruments[i]]]
    )
  
  # Compute overall Limits of Agreement (LoA)
  mean_diff <- mean(df$Differences, na.rm = TRUE)
  sd_diff <- sd(df$Differences, na.rm = TRUE)
  loa_upper <- mean_diff + 1.96 * sd_diff
  loa_lower <- mean_diff - 1.96 * sd_diff

  # Create Bland-Altman plot with neon pink regression line
  p <- ggplot(df, aes(x = Mean_Values, y = Differences, color = group)) +
    geom_point(alpha = 0.6, size = 2) +  # Points for each group
    geom_hline(yintercept = mean_diff, linetype = "solid", color = "black", linewidth = 1) +  # Mean bias line
    geom_hline(yintercept = c(loa_upper, loa_lower), linetype = "dashed", color = "black", linewidth = 1) +  # LoA lines
    geom_smooth(aes(group = 1), method = "lm", color = "#FF1493", se = TRUE, linewidth = 1.2) +  # Neon pink regression line
    scale_color_manual(values = group_colors) +
    labs(
      title = instrument_labels[i],  # Only instrument name as title
      x = "Mean Jump Height (cm)", 
      y = "Difference (cm)"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      axis.title = element_text(face = "bold", size = 12),
      legend.position = "bottom",
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(color = "black", linewidth = 0.8)
    )
  
  bland_altman_plots[[i]] <- p
}

# Arrange final plot with legends at the bottom
final_plot <- grid.arrange(
  bland_altman_plots[[1]], bland_altman_plots[[2]], 
  bland_altman_plots[[3]], bland_altman_plots[[4]], 
  ncol = 2, nrow = 2
)

# Display the final plot
print(final_plot)

# Save the final Bland-Altman figure with corrected neon color
ggsave(
  filename = "~/Desktop/Bland-Altman_Final_NeonPink.png",
  plot = final_plot,
  width = 12, 
  height = 10, 
  dpi = 300
)
```

```{r}
install.packages("blandr")
```

```{r}
library(blandr)
```

```{r}
# List of instruments to compare against ForceDecks
instruments <- c("my_jump_a_height", "my_jump_b_height", "ai_app_height", "ir_mat_height")

# Store results
bland_altman_results <- list()

for (instrument in instruments) {
  result <- blandr.statistics(
    df$force_decks_height, df[[instrument]], sig.level = 0.95
  )
  
  # Save results in a structured list
  bland_altman_results[[instrument]] <- result
  
  # Print Bias, ULoA, LLoA
  cat("\nInstrument:", instrument)
  cat("\nBias:", round(result$bias, 3), "(", round(result$biasLower, 3), "to", round(result$biasUpper, 3), ")")
  cat("\nULoA:", round(result$upperLOA, 3), "(", round(result$upperLOA_lower, 3), "to", round(result$upperLOA_upper, 3), ")")
  cat("\nLLoA:", round(result$lowerLOA, 3), "(", round(result$lowerLOA_lower, 3), "to", round(result$lowerLOA_upper, 3), ")\n")
}
```

```{r}
# Create empty dataframe for systematic bias results
bias_regression_results <- data.frame(Instrument = character(), Slope = numeric(), P_value = numeric())

for (instrument in instruments) {
  
  # Linear regression model
  bias_model <- lm(df$Differences ~ df$Mean_Values, data = df)
  
  # Store slope and p-value
  bias_regression_results <- rbind(
    bias_regression_results,
    data.frame(
      Instrument = instrument,
      Slope = coef(bias_model)[2],
      P_value = summary(bias_model)$coefficients[2,4]
    )
  )
}

# Display results
print(bias_regression_results)
```

```{r}
# Load required libraries
library(ggplot2)
library(dplyr)
library(gridExtra)

# Define instruments and labels
instruments <- c("my_jump_a_height", "my_jump_b_height", "ai_app_height", "ir_mat_height")
instrument_labels <- c("Slow Motion A", "Slow Motion B", "AI App", "IR Contact Mat")

# Define colors for groups
group_colors <- c("Recreational Athlete" = "#F8766D", 
                  "Basketball" = "#00BA38", 
                  "Soccer" = "#619CFF", 
                  "Volleyball" = "#C77CFF")

# Define Bland-Altman statistics from Samuel's calculations
bland_altman_stats <- data.frame(
  Instrument = instruments,
  Bias = c(0.053, 0.139, -3.188, -0.126),
  Lower_LoA = c(-1.773, -2.411, -34.541, -11.598),
  Upper_LoA = c(1.879, 2.689, 28.165, 11.346)
)

# Ensure the group factor is ordered correctly
df$group <- factor(df$group, levels = c("Recreational Athlete", "Basketball", "Soccer", "Volleyball"))

# Generate individual Bland-Altman plots for each instrument
bland_altman_plots <- list()

for (i in seq_along(instruments)) {
  
  # Compute means and differences for each instrument
  df <- df %>%
    mutate(
      Mean_Values = (force_decks_height + .data[[instruments[i]]]) / 2,
      Differences = force_decks_height - .data[[instruments[i]]]
    )
  
  # Extract Bias and Limits of Agreement (LoA)
  bias_value <- bland_altman_stats$Bias[i]
  lower_loa <- bland_altman_stats$Lower_LoA[i]
  upper_loa <- bland_altman_stats$Upper_LoA[i]

  # Create Bland-Altman plot with neon pink regression line
  p <- ggplot(df, aes(x = Mean_Values, y = Differences, color = group)) +
    geom_point(alpha = 0.6, size = 2) +  # Points for each group
    geom_hline(yintercept = bias_value, linetype = "solid", color = "black", linewidth = 1) +  # Mean bias line
    geom_hline(yintercept = c(upper_loa, lower_loa), linetype = "dashed", color = "black", linewidth = 1) +  # LoA lines
    geom_smooth(aes(group = 1), method = "lm", color = "#FF1493", se = TRUE, linewidth = 1.2) +  # Neon pink regression line
    scale_color_manual(values = group_colors) +
    labs(
      title = paste0(instrument_labels[i], 
                     "\nBias: ", round(bias_value, 2), 
                     " | ULoA: ", round(upper_loa, 2), 
                     " | LLoA: ", round(lower_loa, 2)),  # Title includes Bias, ULoA, LLoA
      x = "Mean Jump Height (cm)", 
      y = "Difference (cm)"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      axis.title = element_text(face = "bold", size = 12),
      legend.position = "bottom",
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(color = "black", linewidth = 0.8)
    )
  
  bland_altman_plots[[i]] <- p
}

# Arrange final plot with legends at the bottom
final_plot <- grid.arrange(
  bland_altman_plots[[1]], bland_altman_plots[[2]], 
  bland_altman_plots[[3]], bland_altman_plots[[4]], 
  ncol = 2, nrow = 2
)

# Display the final plot
print(final_plot)

# Save the final Bland-Altman figure with corrected neon color
ggsave(
  filename = "~/Desktop/Bland-Altman_Final_NeonPink_With_Stats.png",
  plot = final_plot,
  width = 12, 
  height = 10, 
  dpi = 300
)
```

```{r}
# Load required libraries
library(ggplot2)
library(dplyr)

# Define colors for groups
group_colors <- c("Recreational Athlete" = "#F8766D", 
                  "Basketball" = "#00BA38", 
                  "Soccer" = "#619CFF", 
                  "Volleyball" = "#C77CFF")

# Define shapes for instruments
instrument_shapes <- c("Slow Motion A" = 16,  # Filled circle
                       "Slow Motion B" = 17,  # Triangle
                       "AI App" = 15,        # Square
                       "IR Contact Mat" = 18) # Diamond

# Transform data: combine all instruments into one dataset
ba_data <- df %>%
  pivot_longer(cols = c("my_jump_a_height", "my_jump_b_height", "ai_app_height", "ir_mat_height"), 
               names_to = "Instrument", values_to = "Measured_Height") %>%
  mutate(
    Mean_Values = (force_decks_height + Measured_Height) / 2,
    Differences = force_decks_height - Measured_Height,
    Instrument = factor(Instrument, 
                        levels = c("my_jump_a_height", "my_jump_b_height", "ai_app_height", "ir_mat_height"),
                        labels = c("Slow Motion A", "Slow Motion B", "AI App", "IR Contact Mat"))
  )

# Compute overall Limits of Agreement (LoA)
mean_diff <- mean(ba_data$Differences, na.rm = TRUE)
sd_diff <- sd(ba_data$Differences, na.rm = TRUE)
loa_upper <- mean_diff + 1.96 * sd_diff
loa_lower <- mean_diff - 1.96 * sd_diff

# Create unified Bland-Altman plot
final_ba_plot <- ggplot(ba_data, aes(x = Mean_Values, y = Differences, color = group, shape = Instrument)) +
  geom_point(alpha = 0.6, size = 2) +  # Points for each group and instrument
  geom_hline(yintercept = mean_diff, linetype = "solid", color = "black", linewidth = 1) +  # Mean bias line
  geom_hline(yintercept = c(loa_upper, loa_lower), linetype = "dashed", color = "black", linewidth = 1) +  # LoA lines
  geom_smooth(aes(group = 1), method = "lm", color = "#FF1493", se = TRUE, linewidth = 1.2) +  # Neon pink regression line
  scale_color_manual(values = group_colors) +
  scale_shape_manual(values = instrument_shapes) +
  labs(
    title = "Bland-Altman Plot: All Groups and Instruments",
    x = "Mean Jump Height (cm)", 
    y = "Difference (cm)",
    color = "Group",
    shape = "Instrument"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(face = "bold", size = 14),
    axis.text.x = element_text(size = 12, face = "bold"),  
    axis.text.y = element_text(size = 12),
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.8)
  )

# Display the final plot
print(final_ba_plot)

# Save the unified Bland-Altman figure
ggsave(
  filename = "~/Desktop/Bland-Altman_All_Groups_Instruments.png",
  plot = final_ba_plot,
  width = 12, 
  height = 10, 
  dpi = 300
)
```

# OLP

## OLP BMB Stats

```{r}
# Load necessary libraries
library(bmbstats)
library(ggplot2)

# Create OLP BMB Stats Plot using the correct variable names
bmbstats::plot_pair_OLP(
  predictor = cmj_df$ai_app_height,  # AI App height variable
  outcome = cmj_df$force_decks_height,  # Force Platform height variable
  predictor_label = "AI App",
  outcome_label = "Force Platform",
  SESOI_lower = -2.5,
  SESOI_upper = 2.5,
  confidence = 0.95
) + 
  annotate("text", x = 1, y = 60, label = "y = -1.49 (-2.98 - 0.04)", color = "red") +
  annotate("text", x = 1, y = 57, label = "x = 0.97 (0.93 - 1.00)", color = "red")
```

```{r}
# Set the file path to save Supplemental Figure 2 (OLP BMB Stats)
file_path <- "/Users/pablotadeo/Desktop/Supplemental_Figure_2_OLP_BMB.png"

# Save the last generated plot (OLP BMB Stats)
ggsave(filename = file_path, plot = last_plot(), width = 12, height = 10, dpi = 300)
```

```{r}
# Load necessary libraries
library(bmbstats)
library(ggplot2)

# Create OLP BMB Stats Plot
plot_olp_bmb <- bmbstats::plot_pair_OLP(
  predictor = cmj_df$ai_app_height,  # AI App height variable
  outcome = cmj_df$force_decks_height,  # Force Platform height variable
  predictor_label = "AI App",
  outcome_label = "Force Platform",
  SESOI_lower = -2.5,
  SESOI_upper = 2.5,
  confidence = 0.95
) + 
  annotate("text", x = 1, y = 60, label = "y = -1.49 (-2.98 - 0.04)", color = "red") +
  annotate("text", x = 1, y = 57, label = "x = 0.97 (0.93 - 1.00)", color = "red") +
  labs(title = "Supplemental Figure 2. OLP BMB Stats Plot") +  # Add the title inside the figure
  theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5))  # Center and style title

# Display the updated plot
print(plot_olp_bmb)

# Save the updated figure with title
file_path <- "/Users/pablotadeo/Desktop/Supplemental_Figure_2_OLP_BMB.png"
ggsave(filename = file_path, plot = plot_olp_bmb, width = 12, height = 10, dpi = 300)
```

## OLP Regression

```{r}
# Load necessary library
library(bmbstats)

# Define the OLP regression function
olp_method <- function(data,
                       criterion,
                       practical,
                       SESOI_lower = 0,
                       SESOI_upper = 0,
                       na.rm = FALSE) {
  practical_obs <- data[[practical]]
  criterion_obs <- data[[criterion]]

  SESOI_range <- SESOI_upper - SESOI_lower

  olp_model <- bmbstats::OLP_regression(
    outcome = criterion_obs,
    predictor = practical_obs,
    na.rm = na.rm
  )

  n_obs <- length(criterion_obs)

  intercept <- olp_model$intercept
  slope <- olp_model$slope
  rse <- olp_model$rse

  PPER <- stats::pt((SESOI_upper) / rse, df = n_obs - 1) -
    stats::pt((SESOI_lower) / rse, df = n_obs - 1)

  c(
    "Intercept" = intercept,
    "Slope" = slope,
    "RSE" = rse,
    PPER = PPER
  )
}
```

```{r}
# Perform OLP Regression Analysis for AI App vs. Force Platform
olp_validity <- bmbstats::validity_analysis(
  data = cmj_df,
  criterion = "force_decks_height",  # Reference standard (Force Platform)
  practical = "ai_app_height",  # AI App measurement
  SESOI_lower = -2.5,
  SESOI_upper = 2.5,
  estimator_function = olp_method,
  control = model_control(seed = 1667)
)

# Print the results
print(olp_validity)
```

```{r}
# Load necessary libraries
library(gt)
library(dplyr)

# Create formatted DataFrame for Supplemental Table 2
supplemental_table_2 <- data.frame(
  Estimator = c("Intercept", "Slope", "RSE", "PPER"),
  Value = c(4.2344642, 0.9033465, 4.0091507, 0.4667898),
  Lower = c(2.7614315, 0.8462918, 3.4776138, 0.3980591),
  Upper = c(6.2935251, 0.9428875, 4.7917943, 0.5274649)
)

# Generate gt table with the correct formatting
supplemental_table_2 %>%
  gt() %>%
  tab_header(
    title = "Supplemental Table 2. Ordinary Least Products (OLP) Regression Results"
  ) %>%
  cols_label(
    Estimator = "Estimator",
    Value = "Value",
    Lower = "Lower",
    Upper = "Upper"
  ) %>%
  fmt_number(
    columns = c(Value, Lower, Upper),
    decimals = 4
  ) %>%
  tab_options(
    table.font.size = 12,
    column_labels.font.weight = "bold",
    data_row.padding = px(6)
  )

# Save table as CSV in correct format
write.csv(supplemental_table_2, "/Users/pablotadeo/Desktop/Supplemental_Table_2_OLP.csv", row.names = FALSE)

# Print table for verification
print(supplemental_table_2)
```

```{r}
# Load necessary libraries
library(ggplot2)

# Extract regression coefficients from OLP results
intercept <- olp_validity$estimators$value[1]  # Extracting the intercept
slope <- olp_validity$estimators$value[2]  # Extracting the slope

# Create OLP Regression Plot
ggplot(cmj_df, aes(x = ai_app_height, y = force_decks_height)) +
  geom_point(color = "#F8766D", size = 3, alpha = 0.7) +  # Data points
  geom_abline(intercept = intercept, slope = slope, color = "#00BFC4", size = 1.2) +  # Regression line
  labs(x = "AI App Jump Height (cm)", 
       y = "Force Platform Jump Height (cm)", 
       title = "Supplemental Figure 3. Ordinary Least Products (OLP) Regression") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 12, face = "bold"),
        axis.text.y = element_text(size = 12, face = "bold"),
        axis.title = element_text(size = 14, face = "bold"),
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(size = 0.8))
```

# Supplemental Figures

```{r}
# Load necessary libraries
library(ggplot2)
library(patchwork)  # To combine plots

# Define instrument and group order
instrument_order <- c("Force Platform", "Slow Motion A", "Slow Motion B", "AI App", "IR Contact Mat")
group_order <- c("Recreational Athletes", "Basketball", "Soccer", "Volleyball")

# CV data for all instruments (Test-Retest)
cv_all <- data.frame(
  Instrument = factor(rep(instrument_order, each = 2), levels = instrument_order),  
  Session = factor(rep(c("Test", "Retest"), times = 5), levels = c("Test", "Retest")),  
  CV_Percentage = c(3.352, 3.327, 3.326, 3.294, 3.281, 3.176, 6.744, 6.573, 3.362, 3.511)
)

# CV data by group and instrument (Test-Retest)
cv_group <- data.frame(
  Group = factor(rep(group_order, each = 10), levels = group_order),  
  Instrument = factor(rep(instrument_order, times = 8), levels = instrument_order),  
  Session = factor(rep(c("Test", "Retest"), times = 20), levels = c("Test", "Retest")),  
  CV_Percentage = c(4.444, 3.944, 2.899, 2.521, 3.615, 4.350, 2.505, 2.522,
                    3.330, 3.586, 2.804, 2.782, 3.921, 4.320, 3.248, 2.505,
                    3.485, 3.773, 2.657, 2.845, 3.567, 3.827, 3.426, 2.290,
                    7.604, 6.980, 5.142, 4.037, 6.567, 7.890, 7.705, 7.405,
                    3.656, 3.662, 2.898, 3.312, 4.039, 4.162, 2.870, 2.914)
)

# Define colors (consistent with Figure 4)
color_palette <- c("Test" = "#F8766D", "Retest" = "#00BFC4")  
group_colors <- c("Recreational Athletes" = "#00BA38", "Basketball" = "#F8766D", 
                  "Soccer" = "#619CFF", "Volleyball" = "#C77CFF")  

# Plot 1: CV Across All Instruments
cv_all_plot <- ggplot(cv_all, aes(x = Instrument, y = CV_Percentage, color = Session)) +
  geom_point(size = 4, position = position_dodge(width = 0.6)) +  
  geom_errorbar(aes(ymin = CV_Percentage - 0.1, ymax = CV_Percentage + 0.1), 
                width = 0.2, position = position_dodge(width = 0.6)) +  
  scale_color_manual(values = color_palette) +  
  labs(title = "CV Across Measurement Instruments (Test-Retest Sessions)",
       x = "Instrument",
       y = "CV (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 12, face = "bold"), 
        axis.text.y = element_text(size = 12, face = "bold"),
        axis.title = element_text(size = 14, face = "bold"),
        plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
        legend.position = "top",
        legend.title = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_line(size = 0.8))

# Plot 2: CV by Group and Instrument
cv_group_plot <- ggplot(cv_group, aes(x = Instrument, y = CV_Percentage, color = Group)) +
  geom_point(size = 4, position = position_dodge(width = 0.6)) +  
  geom_errorbar(aes(ymin = CV_Percentage - 0.1, ymax = CV_Percentage + 0.1), 
                width = 0.2, position = position_dodge(width = 0.6)) +  
  scale_color_manual(values = group_colors) +  
  labs(title = "CV by Athlete Group and Instrument (Test-Retest Sessions)",
       x = "Instrument",
       y = "CV (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 12, face = "bold"), 
        axis.text.y = element_text(size = 12, face = "bold"),
        axis.title = element_text(size = 14, face = "bold"),
        plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
        legend.position = "top",
        legend.title = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_line(size = 0.8))

# Combine both plots into one figure
final_cv_figure <- cv_all_plot / cv_group_plot + 
  plot_annotation(title = "Supplemental Figure 1. Coefficient of Variation (CV) Across Measurement Instruments and Athlete Groups (Test-Retest Sessions)",
                  theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5)))

# Display the final figure
print(final_cv_figure)
```

```{r}
# Set the file path to your desktop (adjust if necessary)
file_path <- "/Users/pablotadeo/Desktop/Supplemental_Figure_1_CV.png"

# Save the last created plot as a high-quality PNG
ggsave(
  filename = file_path, 
  plot = last_plot(),   # Use the last plot created
  width = 12,           # Width in inches
  height = 10,          # Height in inches
  dpi = 300             # High resolution for publication-quality image
)

# Confirm the file save
print(paste("Figure saved at:", file_path))
```
